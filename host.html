<!DOCTYPE html>
<html lang="sv">

<head>
    <meta charset="UTF-8" />
    <title>FestQuiz – Host</title>
    <style>
        body {
            font-family: system-ui, Arial, sans-serif;
            background: #0f172a;
            color: #e5e7eb;
            padding: 24px;
        }

        h1 {
            margin-bottom: 8px;
        }

        .room {
            font-size: 1.2rem;
            margin-bottom: 16px;
        }

        .hint {
            opacity: 0.7;
            margin-top: 12px;
            font-size: 0.9rem;
        }

        button {
            padding: 12px 16px;
            font-size: 1rem;
            border-radius: 8px;
            border: none;
            background: #1e293b;
            color: #e5e7eb;
            cursor: pointer;
        }

        button:disabled {
            opacity: 0.5;
        }
    </style>
</head>

<body>

    <h1>Spelledare</h1>

    <div class="room">
        Room: <strong id="roomCode">–</strong>
    </div>

    <!-- Host spelar själv (valfritt) -->
    <div id="hostPlaysBox" style="display:none; margin: 12px 0; max-width: 420px;">
        <div style="opacity:0.8; margin-bottom:8px;">Du spelar också</div>
        <input id="hostName" type="text" placeholder="Ditt namn" autocomplete="off"
            style="width:100%; padding:12px; border-radius:8px; border:none; margin-bottom:10px; font-size:1rem;" />
        <button id="hostJoinBtn">Gå med som spelare</button>
    </div>

    <button id="startBtn" style="margin:24px 0;">
        Starta quiz
    </button>

    <div id="status" style="margin-top:12px; opacity:0.8;"></div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const roomCode = params.get("room");
        const hostPlays = params.get("hostPlays") === "true";

        const roomEl = document.getElementById("roomCode");
        const statusEl = document.getElementById("status");

        const hostPlaysBox = document.getElementById("hostPlaysBox");
        const hostNameEl = document.getElementById("hostName");
        const hostJoinBtn = document.getElementById("hostJoinBtn");

        if (!roomCode) {
            roomEl.textContent = "SAKNAS";
            throw new Error("Missing room code");
        }

        roomEl.textContent = roomCode.toUpperCase();

        if (hostPlays) {
            hostPlaysBox.style.display = "block";

            hostJoinBtn.addEventListener("click", async () => {
                const name = (hostNameEl.value || "").trim();
                if (!name) return;

                statusEl.textContent = "Går med som spelare…";
                hostJoinBtn.disabled = true;

                try {
                    const res = await fetch(
                        `/room/join?room=${encodeURIComponent(roomCode)}&name=${encodeURIComponent(name)}`,
                        { method: "POST" }
                    );

                    if (!res.ok) throw new Error();

                    const data = await res.json();
                    localStorage.setItem("festquiz_playerId", data.playerId);

                    statusEl.textContent = "Du är med som spelare.";
                    hostPlaysBox.style.display = "none";
                } catch {
                    statusEl.textContent = "Kunde inte gå med som spelare.";
                    hostJoinBtn.disabled = false;
                }
            });
        }
    </script>

    <script>
        // === STARTA QUIZ (V2 – STATE ONLY) ===
        startBtn.addEventListener("click", async () => {
            startBtn.disabled = true;
            statusEl.textContent = "Startar quiz…";

            try {
                const res = await fetch(`/room/start?room=${roomCode}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        category: params.get("category") || null
                    })
                });

                if (!res.ok) throw new Error();

                statusEl.textContent = "Quiz startat.";

            } catch {
                statusEl.textContent = "Kunde inte starta quiz.";
                startBtn.disabled = false;
            }
        });
    </script>
</body>

</html>